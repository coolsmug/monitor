<%- include ("./include/header.ejs") %>

<%- include ("./include/_dash_board.ejs") %>

<div class="diverr">
    <h4><i class="fas fa-house-user"></i>Update Blog</h4>
    <div class="direct">
      <a href="/admin/get-all-blogs/1" class="btn border-shadow"><i class="fas fa-arrow-left"></i> Back to Blogs</a>
  </div>

    <div class="form_for_create">
        
        <%- include ('./partials/messages') %>

        <!-- Blog Details Form -->
        <form id="eventForm" action="/admin/edit-blog/<%= blog._id %>" method="POST">
          <div class="all-single-form">
            <div class="mb-3">
              <div class="hop">
                <label for="author">Author:</label>
                <input type="text" name="author" value="<%= blog.author || '' %>" required />
              </div>
        
              <div class="hop">
                <label for="category">Category:</label>
                <select id="category" name="category" required>
                  <option value="">-- Select Category --</option>
                  
                  <option value="politics">Politics</option>
                  <option value="business">Business & Economy</option>
                  <option value="technology">Technology</option>
                  <option value="health">Health</option>
                  <option value="education">Education</option>
                  <option value="sports">Sports</option>
                  <option value="entertainment">Entertainment</option>
                  <option value="lifestyle">Lifestyle</option>
                  <option value="world">World News</option>
                  <option value="opinion">Opinion / Editorial</option>
                  <option value="religion">Religion News</option>
                  <option value="school_news">School News</option>
                </select>
                <script>
                  // Set the selected category based on the blog data
                  document.getElementById('category').value = "<%= blog.category || '' %>";
                </script>
              </div>
        
              <div class="hop">
                <label for="headline">Headline:</label>
                <input type="text" name="headline" value="<%= blog.headline || '' %>" required />
              </div>
        
              <div class="hop">
                <label for="isFeatured">Position:</label>
                <select name="isFeatured">
                  <option value="false" <%= blog.isFeatured == false ? 'selected' : '' %>>False</option>
                  <option value="true" <%= blog.isFeatured == true ? 'selected' : '' %>>True</option>
                </select>
              </div>
        
              <div class="hop">
                <label for="tags">Tags (separated by double spacing):</label>
                <input type="text" name="tags" value="<%= blog.tags || '' %>" placeholder="e.g. education, school, teachers" />
              </div>
        
              <div class="hop">
                <label for="status">Status:</label>
                <select name="status">
                  <option value="published" <%= blog.status === 'published' ? 'selected' : '' %>>Published</option>
                  <option value="draft" <%= blog.status === 'draft' ? 'selected' : '' %>>Draft</option>
                  <option value="archived" <%= blog.status === 'archived' ? 'selected' : '' %>>Archived</option>
                </select>
              </div>
        
              <div class="hop">
                <label for="content">Content:</label>
                <textarea name="content" id="content" placeholder="Enter your blog content here..." required><%= blog.content || '' %></textarea>
              </div>
        
              <div class="hop">
                <label for="metaDescription">Meta Description (optional):</label>
                <textarea name="metaDescription" placeholder="Short meta description (max 160 characters)"><%= blog.metaDescription || '' %></textarea>
              </div>
            </div>
          </div>
        
          <div class="mb-3">
            <input type="submit" value="Publish Blog">
          </div>
        </form>
        
    </div>

    <!-- Event Image Upload Form -->
    <div class="form_for_create">

      <form id="pageImageForm" action="/admin/edit-blog-image/<%= blog._id %>" method="POST" enctype="multipart/form-data">

            <div class="form-group">
                <div class="hop">
                    <label for="img">Upload Event Image</label>
                    <input type="file" name="img" id="img">
                </div>
            </div>
            <div class="mb-3">
                <input type="submit" value="Upload Page Image">
            </div>
        </form>

    </div>

</div>

<footer class="foot">
    <h3>All rights reserved and Powered by Dark theme code <i class="fas fa-copyright"></i> 2024</h3>
</footer>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const eventForm = document.getElementById('eventForm');

    if (eventForm) {
      eventForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Convert form fields into a plain JS object
        const formDataObj = Object.fromEntries(new FormData(e.target).entries());

        try {
          const response = await fetch(e.target.action, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(formDataObj),
          });

          if (response.ok) {
            const result = await response.json();
            alert(result.message);
            window.location.href = result.redirectUrl;
          } else {
            const error = await response.json();
            alert('Error updating event: ' + error.error); // use .error since backend sends { error: ... }
          }
        } catch (err) {
          console.error('Error:', err);
          alert('An error occurred while updating the event.');
        }
      });
    }
  });
</script>

<%- include ("./include/footer.ejs") %>
