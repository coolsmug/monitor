<%- include ("./include/header.ejs") %> 
<%- include ("./include/_dash_board.ejs") %> 

<div class="divh4"><h1>Class: <%= presentClass.name %></h1> <h1>Arm: <%= presentClass.arm %></h1></div>
<div class="div_promote">
    <%- include ('./partials/messages') %> 
    <% for (var l = 0; l < users.length; l++) {%>
        <form action="/admin/promotion/<%= users[l]._id %>" method="post" class="promote-form">
          <div class="avi aviss">        
           
           
              <img src="<%= users[l].img && users[l].img.url ? users[l].img.url : 'https://res.cloudinary.com/idrynod-001/image/upload/v1756835528/emblems_jk6gea.jpg' %>">
           
          </div>
          <div class="dv_names">
            <p><%= users[l].first_name %> <%= users[l].last_name %> <%= users[l].middle_name %> </p>
            <p><%= users[l].classes %> </p>
          </div>
          <div class="div_forms">
            <label for="id">Class Name:</label>
            <select name="classId" id="classId">
                
                <% for (var i = 0; i < classed.length; i++) { %>
                    <option value="<%= classed[i]._id %>">
                      <%= classed[i].name %> of <%= classed[i].arm %>
                    </option>
                <% } %>
            </select>
          </div>
          <div class="div_forms">
            <button type="button" class="promote-button" data-user-id="<%= users[l]._id %>">Ok? promote!</button>
          </div>
        </form>
      <% } %> 
       

  
    <form action="/admin/promotionall" method="post" class="promote">
        <div class="div_forms">
            <label for="classId">Select Previous Class:</label>
            <select name="classId" id="classId">
                
                <% for (var i = 0; i < classed.length; i++) { %>
                    <option value="<%= classed[i]._id %>">
                      <%= classed[i].name %>
                    </option>
                <% } %>
            </select>
        </div>
    
        <div class="div_forms">
            <label for="newClassId">Current Class:</label>
            <select name="newClassId" id="classId">
                <option>Select new class</option>
                
                <% for (var i = 0; i < classed.length; i++) { %>
                    <option value="<%= classed[i]._id %>"><%= classed[i].name %></option>
                <% } %>
            </select>
            
        </div>
        
        <div class="div_forms">
            <input type="submit" value="Promote Learners">
        </div>
    </form>
   
</div>

<div class="div-for-promote">
 <form method="POST" id="bulkUpdateForm">
  <div class="input">
    <label style="font-size: 12px; color: rgb(89, 46, 139);">
      Use this form to add Learners to their class by ticking the box
    </label>

    <div class="checkbox-container">
      <% if (student) { %> 
        <% for (var i = 0; i < student.length; i++) { %> 
          <label>
            <!-- Checkbox for selecting learner -->
            <input type="checkbox" class="learner-checkbox" name="learners" value="<%= student[i]._id %>"> 
            <div class="div-ir">
              <div class="img">
                <img src="<%= student[i].img.url %>" alt="" width="70">
              </div>
            </div>
            <p><%= student[i].first_name %> <%= student[i].middle_name %> <%= student[i].last_name %></p>
          </label>
        <% } %> 
      <% } %> 
    </div>

    <!-- Class details (only once) -->
    <input type="hidden" name="classId" value="<%= presentClass._id %>"/>
    <input type="hidden" name="classes" value="<%= presentClass.name %>"/>
    <input type="hidden" name="arm" value="<%= presentClass.arm %>"/>
    <% console.log(classed); %>
  </div>
  
  <div class="div">
    <input type="submit" value="Add Learners to Class">
  </div>
</form>


</div>

<footer class="foot">
    <h3>All rights reserved and Powered by Dark theme code  <i class="fas fa-copyright"> </i> 2024</h3>
</footer>   
<%- include ("./include/footer.ejs") %> 

<style>

  .div-for-promote {
    width: 70%;
    margin: auto;
    display : flex;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
    flex-direction: column;
  }
  .img{
    border-radius: 100%;
    border: 2px solid white;
    display : flex;
    justify-content: center;
    align-items: center;
    width: 70px;
    height: 70px;
    margin: 5px;
     overflow: hidden;
  }

 
    .divh4 {
        width: 50%;
        margin: auto;
        padding-top: 100px;
    }

    .divh4 h1 {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        color: royalblue;
        text-align: center;
    }

    #bulkUpdateForm {
      background: #ececec;
      min-width: 1000px;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      font-family: 'Poppins', sans-serif; 
}

.input {
   margin-bottom: 15px;
   
}

label {
   font-size: 14px;
   font-weight: 600;
   color: #10388da1;
}

/* Checkbox Container - Display in Column */
.checkbox-container {
   display: flex;
   justify-content: center;
   flex-direction: row;
   flex-wrap: wrap;
   gap: 10px;
   padding: 10px 0;
   /* width: 300px;   */
}

.checkbox-container label {
   display: flex;
   justify-content: center;
   align-items: center;
   flex-direction: row;
   text-align: right;
   cursor: pointer;
   background: #8bb9ff;
   padding: 8px 12px;
   border-radius: 5px;
   transition: 0.3s;
   width: 250px;
}

.checkbox-container label:hover {
   background: #d0e2f0;
}

input[type="checkbox"] {
   width: 18px;
   height: 18px;
   cursor: pointer;
   accent-color: rgb(46, 94, 139);
}

/* Submit Button */
.div input[type="submit"] {
   width: 100%;
   background: rgb(46, 75, 139);
   color: white;
   font-size: 16px;
   font-weight: bold;
   border: none;
   padding: 10px;
   border-radius: 5px;
   cursor: pointer;
   transition: 0.3s;
}

.div input[type="submit"]:hover {
   background: rgb(0, 15, 100);
}

/* Responsive Design */
@media (max-width: 400px) {
   #blessing {
       width: 90%;
       padding: 15px;
   }
}
</style>

<script>
    document.addEventListener("DOMContentLoaded", function () {
  const promoteButtons = document.querySelectorAll(".promote-button");

  promoteButtons.forEach((button) => {
    button.addEventListener("click", async (event) => {
      const form = button.closest(".promote-form");
      const formData = new FormData(form);
      const userId = button.getAttribute("data-user-id");

      try {
        const response = await fetch(`/admin/promotion/${userId}`, {
          method: "POST",
          body: formData,
          headers: {
            "X-Requested-With": "XMLHttpRequest",
          },
        });

        if (response.ok) {
          const result = await response.json();
          alert(result.message); // Success message
        } else {
          const error = await response.json();
          alert(error.message); // Error message
        }
      } catch (error) {
        console.error("Error promoting learner:", error);
        alert("An error occurred while promoting the learner.");
      }
    });
  });
});

$("#bulkUpdateForm").submit(function (event) {
  event.preventDefault();

  var formData = new FormData(this);

  // Convert to plain object for easier debugging
  let formObject = {};
  formData.forEach((value, key) => {
    if (formObject[key]) {
      if (!Array.isArray(formObject[key])) {
        formObject[key] = [formObject[key]];
      }
      formObject[key].push(value);
    } else {
      formObject[key] = value;
    }
  });

  console.log("Data being sent:", formObject);

  $.ajax({
    url: "/admin/insert-class",
    method: "POST",
    data: formData,
    processData: false,
    contentType: false,
    success: function (response) {
      alert("Learners updated successfully!");
      console.log(response);
      location.reload();
    },
    error: function (xhr, status, error) {
      alert("Error updating learners: " + error);
      console.log(xhr.responseText);
    }
  });
});



</script>